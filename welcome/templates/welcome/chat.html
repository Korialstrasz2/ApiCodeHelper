<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Persona Chat</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #chat-box { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin-top: 10px; }
        .user { color: blue; }
        .assistant { color: green; }
    </style>
</head>
<body>
    <h1>Persona Chat</h1>
    <div>
        <label for="persona-select">Persona:</label>
        <select id="persona-select"></select>
    </div>
    <div>
        <label><input type="checkbox" id="rp-checkbox" />RP</label>
    </div>
    <div>
        <label><input type="checkbox" id="unlock-checkbox" />Unlock context (~200k tokens)</label>
    </div>
    <div>
        <label><input type="checkbox" id="english-checkbox" />English</label>
    </div>
    <div id="persona-error" style="color: red;"></div>
    <div>
        <label for="api-select">API:</label>
        <select id="api-select">
            <option value="ollama">Ollama</option>
            <option value="mistral">Mistral</option>
            <option value="openai">OpenAI</option>
            <option value="openrouter" selected>OpenRouter</option>
        </select>
    </div>
    <div>
        <label for="size-select">Size:</label>
        <select id="size-select">
            <option value="s">S</option>
            <option value="m" selected>M</option>
            <option value="l">L</option>
            <option value="r">R</option>
        </select>
    </div>
    <div id="chat-box"></div>
    <textarea id="message-input" placeholder="Scrivi un messaggio"></textarea>
    <button id="send-btn">Invia</button>
    <button id="toggle-api-log">Mostra/Nascondi API Calls</button>
    <div id="api-log" style="display: none;"></div>

    <script>
    async function loadPersonas() {
        const res = await fetch(`/api/personas/`);
        const data = await res.json();
        const select = document.getElementById('persona-select');
        const prev = select.value;
        select.innerHTML = '';
        data.personas.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.dataset.name = p.nome;
            opt.textContent = p.nome + ' v' + p.versione;
            if ((prev && String(p.id) === prev) || (!prev && p.nome === 'AI Help')) {
                opt.selected = true;
            }
            select.appendChild(opt);
        });
        const errDiv = document.getElementById('persona-error');
        errDiv.textContent = data.personas.length ? '' : 'Nessuna persona trovata';
    }

    const apiCalls = [];

    function updateApiLog() {
        const logDiv = document.getElementById('api-log');
        logDiv.innerHTML = apiCalls.map(call => {
            const debug = call.response.debug_prompt
                ? `<details><summary>Debug Prompt</summary><pre>${JSON.stringify(call.response.debug_prompt, null, 2)}</pre></details>`
                : '';
            return `<pre>${JSON.stringify(call, null, 2)}</pre>${debug}`;
        }).join('');
    }

    async function sendMessage() {
        const msg   = document.getElementById('message-input').value;
        const sel   = document.getElementById('persona-select');
        const api   = document.getElementById('api-select').value;
        const size  = document.getElementById('size-select').value;
        const rp    = document.getElementById('rp-checkbox').checked;
        const inglese = document.getElementById('english-checkbox').checked;
        const unlock = document.getElementById('unlock-checkbox').checked;
        if (!msg) return;
        const personaName = sel.selectedOptions[0]?.dataset.name || null;
        const personaId   = sel.value ? parseInt(sel.value, 10) : null;
        const chatBox = document.getElementById('chat-box');
        chatBox.innerHTML += `<div class="user">Tu: ${msg}</div>`;
        document.getElementById('message-input').value = '';
        const payload = {
            message: msg,
            local: api,
            size,
            persona_name: personaName,
            persona_id: personaId,
            inglese,
            rp,
            unlock
        };
        const res = await fetch('/api/programming_helper/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        apiCalls.push({ request: payload, response: data });
        if (apiCalls.length > 2) apiCalls.shift();
        updateApiLog();
        if (data.response) {
            chatBox.innerHTML += `<div class="assistant">Bot: ${data.response}</div>`;
        } else if (data.error) {
            chatBox.innerHTML += `<div class="assistant">Errore: ${data.error}</div>`;
        }
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    document.getElementById('send-btn').addEventListener('click', sendMessage);
    document.getElementById('toggle-api-log').addEventListener('click', () => {
        const logDiv = document.getElementById('api-log');
        logDiv.style.display = logDiv.style.display === 'none' ? 'block' : 'none';
    });

    const messageInput = document.getElementById('message-input');
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    document.getElementById('rp-checkbox').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('api-select').value = 'openrouter';
            document.getElementById('size-select').value = 'l';
        }
    });
    document.getElementById('english-checkbox').addEventListener('change', loadPersonas);
    loadPersonas();
    </script>
</body>
</html>
